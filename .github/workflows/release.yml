name: Moodle Plugin CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-22.04

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    strategy:
      fail-fast: false
      matrix:
        include:
          - php: "8.3"
            moodle-branch: "MOODLE_405_STABLE"
            dbtype: "pgsql"

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: pgsql, intl, zip, xml, dom, mbstring, curl, json
          ini-values: max_input_vars=5000
          coverage: pcov

      - name: Install moodle-plugin-ci
        run: |
          composer create-project -n --no-dev --prefer-dist moodlehq/moodle-plugin-ci ci ^4
          echo "$(cd ci/bin && pwd)" >> $GITHUB_PATH
          echo "$(cd ci/vendor/bin && pwd)" >> $GITHUB_PATH
          sudo locale-gen en_AU.UTF-8
        env:
          COMPOSER_NO_INTERACTION: 1

      - name: Install Moodle and required Workplace plugins
        run: |
          # Добавляем зависимые Workplace плагины
          mkdir -p /home/runner/work/moodle
          moodle-plugin-ci add-plugin --branch MOODLE_400_STABLE moodleworkplace/moodle-tool_certificate
          moodle-plugin-ci add-plugin --branch MOODLE_400_STABLE moodleworkplace/moodle-mod_coursecertificate

          # Устанавливаем Moodle и сам сабплагин
          moodle-plugin-ci install \
            --moodle /home/runner/work/moodle \
            --plugin . \
            --db-type=${{ matrix.dbtype }} \
            --db-host=127.0.0.1 \
            --db-user=postgres \
            --db-pass=postgres \
            --db-name=moodle \
            --branch=${{ matrix.moodle-branch }}
        env:
          DB: ${{ matrix.dbtype }}
          MOODLE_BRANCH: ${{ matrix.moodle-branch }}

      - name: Lint PHP
        run: |
          moodle-plugin-ci phplint --exclude=ci,.github,vendor,tests .

      - name: PHP CodeSniffer
        run: moodle-plugin-ci phpcs --max-warnings 0 .

      - name: PHPDoc checker
        run: moodle-plugin-ci phpdoc --max-warnings 0 .

      - name: Validate plugin
        run: moodle-plugin-ci validate .

      - name: Savepoints
        run: moodle-plugin-ci savepoints .

      - name: Unit tests
        run: moodle-plugin-ci phpunit --fail-on-warning --coverage-text .

      - name: Package release (main branch only)
        if: github.ref == 'refs/heads/main' && success()
        run: |
          zip -r certificateelement_autonumber.zip . -x ".github/*" ".git/*" ".gitignore" ".*" "__MACOSX/*" ".DS_Store"
          TAG="v$(date +'%Y.%m.%d.%H%M')"
          gh release create "$TAG" certificateelement_autonumber.zip -t "Release $TAG" -n "Automated release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
