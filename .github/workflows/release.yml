name: Moodle Plugin CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-22.04

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    strategy:
      fail-fast: false
      matrix:
        include:
          - php: "8.3"
            moodle-branch: "MOODLE_400_STABLE"
            dbtype: "pgsql"

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          path: .

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: pgsql, intl, zip, xml, dom, mbstring, curl, json
          ini-values: max_input_vars=5000
          coverage: pcov

      - name: Install moodle-plugin-ci
        run: |
          composer create-project -n --no-dev --prefer-dist moodlehq/moodle-plugin-ci ci ^4
          echo "$(cd ci/bin && pwd)" >> $GITHUB_PATH
          echo "$(cd ci/vendor/bin && pwd)" >> $GITHUB_PATH
          sudo locale-gen en_AU.UTF-8
        env:
          COMPOSER_NO_INTERACTION: 1

      - name: Prepare Workplace dependencies and plugin
        run: |
          mkdir -p .deps/moodle/admin/tool
          mkdir -p .deps/moodle/mod

          # Клонируем стабильные версии зависимостей
          git clone --branch MOODLE_400_STABLE --depth 1 https://github.com/moodleworkplace/moodle-tool_certificate.git .deps/moodle/admin/tool/certificate
          git clone --branch MOODLE_400_STABLE --depth 1 https://github.com/moodleworkplace/moodle-mod_coursecertificate.git .deps/moodle/mod/coursecertificate

          # Копируем сабплагин
          mkdir -p .deps/moodle/admin/tool/certificate/element/autonumber
          rsync -av --exclude 'moodle' --exclude '.git' --exclude 'ci' . .deps/moodle/admin/tool/certificate/element/autonumber/
        env:
          COMPOSER_NO_INTERACTION: 1

      - name: Install Moodle + plugin (auto clone)
        run: |
          # Moodle установит ядро сам
          moodle-plugin-ci install \
            --db-type=${{ matrix.dbtype }} \
            --db-host=127.0.0.1 \
            --db-user=postgres \
            --db-pass=postgres \
            --db-name=moodle \
            --branch=${{ matrix.moodle-branch }}

          # После установки Moodle — вручную добавляем зависимости
          mkdir -p moodle/admin/tool
          mkdir -p moodle/mod
          cp -r .deps/moodle/admin/tool/certificate moodle/admin/tool/
          cp -r .deps/moodle/mod/coursecertificate moodle/mod/

          # Копируем сабплагин внутрь установленного Moodle
          mkdir -p moodle/admin/tool/certificate/element/autonumber
          rsync -av --exclude '.git' --exclude '.github' . moodle/admin/tool/certificate/element/autonumber/

          # Обновляем Moodle и запускаем апгрейд
          php moodle/admin/cli/upgrade.php --non-interactive --allow-unstable
        env:
          DB: ${{ matrix.dbtype }}
          MOODLE_BRANCH: ${{ matrix.moodle-branch }}

      - name: Lint PHP
        run: moodle-plugin-ci phplint moodle/admin/tool/certificate/element/autonumber

      - name: PHP CodeSniffer
        run: moodle-plugin-ci phpcs --max-warnings 0 moodle/admin/tool/certificate/element/autonumber

      - name: PHPDoc checker
        run: moodle-plugin-ci phpdoc --max-warnings 0 moodle/admin/tool/certificate/element/autonumber

      - name: Validate plugin
        run: moodle-plugin-ci validate moodle/admin/tool/certificate/element/autonumber

      - name: Savepoints
        run: moodle-plugin-ci savepoints moodle/admin/tool/certificate/element/autonumber

      - name: Unit tests
        run: moodle-plugin-ci phpunit --fail-on-warning --coverage-text

      - name: Package release (main branch only)
        if: github.ref == 'refs/heads/main' && success()
        run: |
          cd moodle/admin/tool/certificate/element
          zip -r ../../../certificateelement_autonumber.zip autonumber
          TAG="v$(date +'%Y.%m.%d.%H%M')"
          gh release create "$TAG" ../../../certificateelement_autonumber.zip -t "Release $TAG" -n "Automated release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup temp deps
        if: always()
        run: rm -rf .deps
